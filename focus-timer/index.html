<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Visual Timer</title>
  <meta name="description" content="Draggable visual timer with optional seconds, auto-start, and end chime.">
  <style>
    :root{
      --bg:#0b1020; --ink:#e2e8f0; --muted:#94a3b8;
      --accent:#7dd3fc; --accent-2:#38bdf8; --card:#11182f;
      --line:#233055; --shadow:0 20px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:"Inter",system-ui,-apple-system,sans-serif;}
    .wrap{max-width:960px;margin:0 auto;padding:28px clamp(16px,5vw,32px) 48px;}
    header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:12px;}
    .brand{font-weight:800;letter-spacing:.2px;font-size:22px;display:flex;align-items:center;gap:10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:20px;padding:18px;box-shadow:var(--shadow);}
    .dial-wrap{display:grid;justify-items:center;gap:12px;margin-top:6px;}
    .dial{width:340px;height:340px;border-radius:50%;
      background:conic-gradient(from 0deg,
        var(--accent) 0deg,
        var(--accent) var(--progress,180deg),
        rgba(255,255,255,.08) var(--progress,180deg),
        rgba(255,255,255,.08) 360deg);
      border:1px solid var(--line);position:relative;box-shadow:0 12px 40px rgba(0,0,0,.35);touch-action:none;pointer-events:none;}
    .dial::after{content:"";position:absolute;inset:18px;border-radius:50%;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.12), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);}
    .knob{pointer-events:auto;cursor:pointer;position:absolute;width:16px;height:16px;background:var(--accent-2);border-radius:50%;border:2px solid #0a0f1f;top:50%;left:50%;transform:translate(-50%,-50%) rotate(var(--arm-rot,-90deg)) translate(142px) rotate(calc(-1*var(--arm-rot,-90deg)));box-shadow:0 0 0 10px rgba(56,189,248,.15),0 8px 24px rgba(0,0,0,.35);}
    .center{position:absolute;inset:52px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;color:var(--muted);}
    .time{font-size:56px;font-variant-numeric:tabular-nums;color:var(--ink);margin:0;line-height:1;}
    .toggles{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:12px;color:var(--muted);}
    .toggle{display:flex;align-items:center;gap:6px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.04);}
    .chip-btn{border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;}
    .footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
    @media(max-width:520px){.dial{width:280px;height:280px}.center{inset:44px}.time{font-size:48px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">⏱️ Visual Timer</div>
      <div class="muted">Auto-start • Drag to set</div>
    </header>

    <section class="card">
      <div class="dial-wrap">
        <div class="dial" id="dial" aria-label="Timer dial">
          <div class="knob" id="knob"></div>
          <div class="center">
            <p class="time" id="timeDisplay">30:00</p>
            <div class="muted" id="status">Running</div>
          </div>
        </div>
      </div>
      <div class="toggles">
        <label class="toggle"><input type="checkbox" id="showSeconds" checked> Show seconds</label>
        <label class="toggle"><input type="checkbox" id="soundOn" checked> Sound on finish</label>
        <button class="chip-btn" id="restart">Restart 30:00</button>
      </div>
    </section>
    <div class="footer" id="ticker"></div>
  </div>

  <audio id="chime" preload="auto" src="data:audio/wav;base64,UklGRsQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YYQAAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA="></audio>

  <script>
    const dial = document.getElementById('dial');
    const knob = document.getElementById('knob');
    const timeDisplay = document.getElementById('timeDisplay');
    const statusEl = document.getElementById('status');
    const showSeconds = document.getElementById('showSeconds');
    const soundOn = document.getElementById('soundOn');
    const restartBtn = document.getElementById('restart');
    const ticker = document.getElementById('ticker');
    const chime = document.getElementById('chime');
    let audioCtx = null;
    let audioPrimed = false;

    const State = { IDLE:'IDLE', RUN:'RUN' };
    let state = {
      focusMs: 30 * 60_000,
      remainingMs: 30 * 60_000,
      runState: State.RUN,
      endTs: null,
      lastWhole: null
    };

    const clamp = (v,min,max)=>Math.min(Math.max(v,min),max);

    function format(ms, withSeconds){
      const total = Math.max(0, Math.floor(ms/1000));
      const m = Math.floor(total/60).toString().padStart(2,'0');
      const s = (total%60).toString().padStart(2,'0');
      return withSeconds ? `${m}:${s}` : `${m}`;
    }

    let audioUnlocked = false;
    function ensureAudioUnlocked(){
      if(audioUnlocked) return;
      try{
        chime.volume = 0;
        const p = chime.play();
        if(p?.catch) p.catch(()=>{});
        chime.pause();
        chime.currentTime = 0;
        const AC = window.AudioContext || window.webkitAudioContext;
        if(AC && !audioCtx){
          audioCtx = new AC();
        }
        audioUnlocked = true;
      }catch(_){}
    }

    function playChime(){
      if(!soundOn.checked) return;
      ensureAudioUnlocked();
      const AC = window.AudioContext || window.webkitAudioContext;
      if(AC){
        if(!audioCtx) audioCtx = new AC();
        if(audioCtx.state === 'suspended'){ audioCtx.resume().catch(()=>{}); }
        const ctx = audioCtx;
        const now = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, now);
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.4, now + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.45);
        osc.connect(gain).connect(ctx.destination);
        osc.start(now);
        osc.stop(now + 0.5);
        return;
      }
      try{
        chime.currentTime = 0;
        chime.volume = 0.8;
        chime.play();
      }catch(_){}
    }

    function render(){
      const withSeconds = showSeconds.checked;
      timeDisplay.textContent = format(state.remainingMs, withSeconds);
      ticker.textContent = '';
      statusEl.textContent = state.runState === State.RUN ? 'Running' : 'Idle';
      const totalAngle = clamp(state.focusMs/1000/60,1,120)*6; // 6° per minute
      const progressAngle = Math.min(360, totalAngle * (state.remainingMs/state.focusMs));
      dial.style.setProperty('--progress', progressAngle+'deg');
      const angleDeg = progressAngle; // 0deg at top
      const angleRad = angleDeg * Math.PI / 180;
      const radius = dial.clientWidth/2 - 22;
      const x = radius * Math.sin(angleRad);  // CSS angles: 0deg at top, sin for x when starting at top
      const y = -radius * Math.cos(angleRad);
      knob.style.transform = `translate(${x}px, ${y}px) translate(-50%, -50%)`;
      document.title = state.runState === State.RUN ? `⏳ ${format(state.remainingMs,true)} • Timer` : 'Visual Timer';
    }

    function setFromAngle(clientX, clientY){
      const rect = dial.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;
      const angle = Math.atan2(clientY-cy, clientX-cx) * 180/Math.PI; // -180..180
      let deg = (angle + 450) % 360; // 0 at top
      let mins = clamp(Math.round(deg/6), 1, 120);
      state.focusMs = mins * 60_000;
      state.remainingMs = state.focusMs;
      start();
    }

    let rafId = null, timeoutId = null;
    const clearTickHandles = () => { if(rafId){cancelAnimationFrame(rafId); rafId=null;} if(timeoutId){clearTimeout(timeoutId); timeoutId=null;} };
    const scheduleTick = () => {
      clearTickHandles();
      if(state.runState !== State.RUN || state.endTs===null) return;
      if(document.hidden){
        timeoutId = setTimeout(tick, 500);
      }else{
        rafId = requestAnimationFrame(tick);
      }
    };

    function start(){
      state.runState = State.RUN;
      state.endTs = Date.now() + state.remainingMs;
      state.lastWhole = Math.floor(state.remainingMs/1000);
      ensureAudioUnlocked();
      scheduleTick();
    }

    function handleComplete(){
      playChime();
      state.runState = State.IDLE;
      state.remainingMs = 0;
      state.endTs = null;
      render();
    }

    function tick(){
      if(state.runState !== State.RUN || state.endTs === null) return;
      const remaining = state.endTs - Date.now();
      if(remaining <= 0){
        handleComplete();
        return;
      }
      state.remainingMs = remaining;
      const whole = Math.floor(remaining/1000);
      if(whole !== state.lastWhole){
        state.lastWhole = whole;
      }
      render();
      scheduleTick();
    }

    // drag only knob
    let dragging=false;
    knob.addEventListener('pointerdown',e=>{dragging=true;ensureAudioUnlocked();knob.setPointerCapture(e.pointerId);setFromAngle(e.clientX,e.clientY);});
    knob.addEventListener('pointermove',e=>{if(!dragging) return; setFromAngle(e.clientX,e.clientY);});
    knob.addEventListener('pointerup',e=>{dragging=false;knob.releasePointerCapture(e.pointerId);});
    knob.addEventListener('pointerleave',()=>dragging=false);

    showSeconds.addEventListener('change', render);
    soundOn.addEventListener('change', ()=>{});
    restartBtn.addEventListener('click', ()=>{state.focusMs=30*60_000;state.remainingMs=state.focusMs;ensureAudioUnlocked();start();});

    // one-time global primer to unlock audio on any first user gesture
    function primeAudioOnce(){
      if(audioPrimed) return;
      audioPrimed = true;
      ensureAudioUnlocked();
      window.removeEventListener('pointerdown', primeAudioOnce);
      window.removeEventListener('touchstart', primeAudioOnce);
      window.removeEventListener('keydown', primeAudioOnce);
    }
    window.addEventListener('pointerdown', primeAudioOnce, {passive:true});
    window.addEventListener('touchstart', primeAudioOnce, {passive:true});
    window.addEventListener('keydown', primeAudioOnce);

    // tab visibility accuracy
    document.addEventListener('visibilitychange',()=>{
      if(state.runState!==State.RUN || state.endTs===null) return;
      const remaining = state.endTs - Date.now();
      if(remaining<=0){ handleComplete(); }
      else { state.remainingMs = remaining; render(); scheduleTick(); }
    });

    // init
    render();
    start();
  </script>
</body>
</html>
