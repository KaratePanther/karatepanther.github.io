<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Focus Timer + Active Breaks</title>
  <meta name="description" content="Pomodoro-style focus timer with active breaks, dial input, presets, auto mode, and sound alerts.">
  <style>
    :root{
      --bg: radial-gradient(circle at 20% 20%, #0f172a 0%, #0b1020 35%, #0a0f1f 70%, #0b0f1f 100%);
      --panel: rgba(255,255,255,0.04);
      --muted: #94a3b8;
      --ink: #e2e8f0;
      --accent: #7dd3fc;
      --accent-strong:#38bdf8;
      --accent-warm:#f59e0b;
      --radius: 18px;
      --shadow: 0 20px 60px rgba(0,0,0,0.35);
      font-family: "Space Grotesk", "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:#0b1020;color:var(--ink);}
    body{background:var(--bg);}
    a{color:inherit}
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:26px clamp(16px,4vw,32px) 36px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    .brand{font-weight:800;letter-spacing:.2px;font-size:20px;display:flex;align-items:center;gap:10px}
    .status{padding:6px 10px;border-radius:12px;background:var(--panel);border:1px solid rgba(255,255,255,.08);color:var(--muted);display:inline-flex;align-items:center;gap:6px}
    .pill{padding:6px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);color:var(--muted);font-size:13px}
    .grid{
      display:grid;
      grid-template-columns:1.1fr 0.9fr;
      gap:18px;
    }
    .card{
      background:var(--panel);
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    h1{margin:0;font-size:30px;line-height:1.2}
    h2{margin:0 0 8px;font-size:18px}
    p{margin:6px 0 0}
    .muted{color:var(--muted)}
    .timer{
      display:flex;flex-direction:column;align-items:center;gap:10px;
    }
    .big{
      font-size:68px;
      font-variant-numeric:tabular-nums;
      letter-spacing:1px;
      margin:8px 0;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .time-input input{
      width:96px;
      background:rgba(12,20,43,.9);
      border:1px solid rgba(255,255,255,.15);
      border-radius:14px;
      color:var(--ink);
      padding:12px 14px;
      font-size:48px;
      text-align:center;
      -moz-appearance:textfield;
      appearance:textfield;
    }
    .time-input input::-webkit-outer-spin-button,
    .time-input input::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }
    .time-input .colon{color:var(--muted); font-size:44px; transform:translateY(3px)}
    .phase-tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.06);
      color:var(--muted);font-size:13px;
    }
    .controls{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
    }
    button, input, select{
      font:inherit;
    }
    .btn{
      padding:12px 16px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#0a0f1f;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      transition:transform .08s ease, box-shadow .12s ease;
    }
    .btn:active{transform:translateY(1px);box-shadow:0 6px 18px rgba(0,0,0,.28)}
    .btn.ghost{
      background:transparent;color:var(--ink);
      border:1px solid rgba(255,255,255,.18);
      box-shadow:none;
    }
    .btn.warn{
      background:linear-gradient(135deg,#fbbf24,var(--accent-warm));
      color:#0f0b05;
    }
    .btn.small{padding:8px 12px;font-size:14px}
    .section-title{
      display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px;
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--ink);
      cursor:pointer;
    }
    .chip.active{background:rgba(125,211,252,.15);border-color:var(--accent);color:var(--accent-strong)}
    .inputs{
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .field{
      display:flex;flex-direction:column;gap:6px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:10px;
      min-width:120px;
      color:var(--muted);
    }
    .field label{font-size:13px;letter-spacing:.2px}
    .field input{
      background:#0c142b;
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      color:var(--ink);
      padding:10px;
      font-size:16px;
    }
    .toggle{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      color:var(--muted);
      cursor:pointer;
    }
    .toggle input{accent-color:var(--accent)}
    .dial-wrap{
      display:grid;
      grid-template-columns:240px 1fr;
      gap:12px;
      align-items:center;
    }
    .dial{
      width:240px;height:240px;
      border-radius:50%;
      background:conic-gradient(from -90deg, rgba(125,211,252,.25) var(--dial-deg, 0deg), rgba(255,255,255,.08) var(--dial-deg, 0deg));
      border:1px solid rgba(255,255,255,.12);
      position:relative;
      box-shadow:0 12px 40px rgba(0,0,0,.35);
      cursor:pointer;
      touch-action:none;
    }
    .dial::after{
      content:"";
      position:absolute;inset:16px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.12), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.06);
    }
    .dial .dot{
      position:absolute;
      width:12px;height:12px;
      background:var(--accent-strong);
      border-radius:50%;
      border:2px solid #0a0f1f;
      top:50%;left:50%;
      transform:translate(-50%, -50%) rotate(var(--dot-rot, -90deg)) translate(104px) rotate(calc(-1 * var(--dot-rot, -90deg)));
      box-shadow:0 0 0 8px rgba(56,189,248,.15), 0 6px 20px rgba(0,0,0,.35);
    }
    .dial .center{
      position:absolute;inset:45px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      color:var(--muted);font-size:14px;text-align:center;
    }
    .dial .center .minutes{
      font-size:38px;color:var(--ink);font-weight:700;
    }
    .mode-switch{
      display:flex;gap:8px;flex-wrap:wrap;
    }
    .active-card{
      background:rgba(125,211,252,.08);
      border:1px solid rgba(125,211,252,.4);
      border-radius:14px;
      padding:12px;
      color:var(--ink);
    }
    .active-card h3{margin:0 0 6px}
    .active-card .muted{color:#b8cff0}
    .flex-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .volume{
      display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);
    }
    input[type="range"]{width:140px}
    @media (max-width:960px){
      .grid{grid-template-columns:1fr}
      .dial-wrap{grid-template-columns:1fr;justify-items:center}
    }
    @media (max-width:520px){
      .controls{flex-direction:column}
      .btn{width:100%;text-align:center}
      .dial{width:200px;height:200px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">⏱️ Focus Timer + Active Breaks</div>
      <div class="status" id="status">Idle</div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="timer">
          <div class="phase-tag" id="phaseTag">Focus ready</div>
          <div class="big time-input" aria-label="Timer value">
            <input id="displayMin" type="number" min="0" max="99" inputmode="numeric" aria-label="Minutes">
            <span class="colon">:</span>
            <input id="displaySec" type="number" min="0" max="59" inputmode="numeric" aria-label="Seconds">
          </div>
          <div class="controls">
            <button class="btn" id="startPauseBtn">Start</button>
            <button class="btn ghost" id="resetBtn">Reset</button>
            <button class="btn warn" id="skipBtn">Skip</button>
            <button class="btn ghost small" id="soundBtn" aria-pressed="true">Sound: On</button>
          </div>
          <div class="volume">
            <label for="volume">Volume</label>
            <input type="range" id="volume" min="0" max="1" step="0.05" value="0.6">
            <span id="volLabel">60%</span>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="section-title">
          <h2>Modes & Presets</h2>
          <div class="mode-switch">
            <button class="chip active" data-mode="dial" id="dialMode">Dial</button>
            <button class="chip" data-mode="digital" id="digitalMode">Digital</button>
          </div>
        </div>

        <div id="dialPanel" class="dial-wrap">
          <div class="dial" id="dial" role="slider" aria-valuemin="1" aria-valuemax="60" aria-valuenow="30" aria-label="Focus minutes dial">
            <div class="dot"></div>
            <div class="center">
              <div class="minutes" id="dialMinutes">30</div>
              <div class="muted">Focus minutes</div>
            </div>
          </div>
          <div>
            <p class="muted" style="margin-top:0">Drag around the ring to set focus minutes (1–60). Snap to full minutes.</p>
            <div class="row" style="margin-top:6px">
              <button class="chip preset" data-focus="15">15 min</button>
              <button class="chip preset" data-focus="30">30 min</button>
              <button class="chip preset" data-focus="60">60 min</button>
              <button class="chip preset" data-focus="90">90 min</button>
            </div>
          </div>
        </div>

        <div id="digitalPanel" style="display:none">
          <div class="inputs">
            <div class="field">
              <label for="focusMinutes">Focus minutes (1–60)</label>
              <input id="focusMinutes" type="number" min="1" max="60" value="30" inputmode="numeric">
            </div>
            <div class="field">
              <label for="focusSeconds">Focus seconds (0–59)</label>
              <input id="focusSeconds" type="number" min="0" max="59" value="0" inputmode="numeric">
            </div>
          </div>
        </div>

        <div class="section-title" style="margin-top:14px">
          <h2>Break Settings</h2>
        </div>
        <div class="inputs">
          <div class="field">
            <label for="breakMinutes">Break minutes (0–30+)</label>
            <input id="breakMinutes" type="number" min="0" max="60" value="5" inputmode="numeric">
          </div>
          <div class="row" style="align-items:flex-end">
            <button class="chip break-preset" data-break="5">5 min</button>
            <button class="chip break-preset" data-break="10">10 min</button>
            <button class="chip break-preset" data-break="15">15 min</button>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <label class="toggle"><input type="checkbox" id="autoToggle"> Auto mode</label>
          <label class="toggle"><input type="checkbox" id="activeToggle" checked> Active break prompts</label>
        </div>
      </section>
    </div>

    <section class="card" id="activeCard" style="display:none;margin-top:14px">
      <div class="flex-between">
        <h3 style="margin:0">Active Break</h3>
        <span class="pill">Stretch & move</span>
      </div>
      <p class="muted" id="exerciseText">Loading...</p>
      <div class="row" style="margin-top:10px">
        <button class="btn ghost small" id="newExercise">New random exercise</button>
        <button class="btn small" id="doneExercise">Done</button>
      </div>
    </section>
  </div>

  <audio id="chime" preload="auto" src="data:audio/wav;base64,UklGRsQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YYQAAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA="></audio>

  <script>
    const $ = (s) => document.querySelector(s);
    const SETTINGS_KEY = 'focus-timer-settings-v1';

    const chime = $('#chime');
    const displayMin = $('#displayMin');
    const displaySec = $('#displaySec');
    const phaseTag = $('#phaseTag');
    const status = $('#status');
    const startPauseBtn = $('#startPauseBtn');
    const resetBtn = $('#resetBtn');
    const skipBtn = $('#skipBtn');
    const soundBtn = $('#soundBtn');
    const volume = $('#volume');
    const volLabel = $('#volLabel');

    const dial = $('#dial');
    const dialMinutes = $('#dialMinutes');
    const dialMode = $('#dialMode');
    const digitalMode = $('#digitalMode');
    const dialPanel = $('#dialPanel');
    const digitalPanel = $('#digitalPanel');

    const focusMinutesInput = $('#focusMinutes');
    const focusSecondsInput = $('#focusSeconds');
    const breakMinutesInput = $('#breakMinutes');
    const autoToggle = $('#autoToggle');
    const activeToggle = $('#activeToggle');

    const activeCard = $('#activeCard');
    const exerciseText = $('#exerciseText');
    const newExercise = $('#newExercise');

    const EXERCISES = [
      "10 push-ups",
      "15 squats",
      "30 jumping jacks",
      "10 lunges (each leg: 5)",
      "20 mountain climbers",
      "30s plank",
      "15 calf raises",
      "20s neck stretch each side",
      "15 glute bridges",
      "10 burpees (go gentle!)"
    ];

    const State = {
      IDLE: 'IDLE',
      RUN_FOCUS: 'RUN_FOCUS',
      PAUSE_FOCUS: 'PAUSE_FOCUS',
      RUN_BREAK: 'RUN_BREAK',
      PAUSE_BREAK: 'PAUSE_BREAK'
    };

    let state = {
      focusMs: 30 * 60_000,
      breakMs: 5 * 60_000,
      remainingMs: 30 * 60_000,
      phase: 'focus',
      runState: State.IDLE,
      auto: false,
      activeBreak: true,
      soundOn: true,
      mode: 'dial',
      endTs: null,
      currentExercise: null
    };

    /* ---------- Persistence ---------- */
    function loadSettings(){
      try{
        const saved = JSON.parse(localStorage.getItem(SETTINGS_KEY));
        if(!saved) return;
        state.focusMs = clamp(saved.focusMs ?? state.focusMs, 60_000, 60*60_000);
        state.breakMs = clamp(saved.breakMs ?? state.breakMs, 0, 60*60_000);
        state.remainingMs = state.focusMs;
        state.auto = !!saved.auto;
        state.activeBreak = saved.activeBreak !== undefined ? !!saved.activeBreak : state.activeBreak;
        state.soundOn = saved.soundOn !== undefined ? !!saved.soundOn : state.soundOn;
        state.mode = saved.mode || state.mode;
        volume.value = saved.volume ?? volume.value;
        volLabel.textContent = Math.round(volume.value*100) + '%';
      }catch(e){}
    }

    function saveSettings(){
      const data = {
        focusMs: state.focusMs,
        breakMs: state.breakMs,
        auto: state.auto,
        activeBreak: state.activeBreak,
        soundOn: state.soundOn,
        mode: state.mode,
        volume: parseFloat(volume.value)
      };
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(data));
    }

    /* ---------- Helpers ---------- */
    function clamp(v, min, max){ return Math.min(Math.max(v, min), max); }

    function format(ms){
      const total = Math.max(0, Math.floor(ms/1000));
      const m = String(Math.floor(total/60)).padStart(2,'0');
      const s = String(total%60).padStart(2,'0');
      return `${m}:${s}`;
    }

    function setTabTitle(){
      if(state.runState === State.IDLE){
        document.title = 'Focus Timer';
        return;
      }
      const icon = state.phase === 'focus' ? '⏳' : '☕';
      document.title = `${icon} ${format(state.remainingMs)} • ${state.phase === 'focus' ? 'Focus' : 'Break'}`;
    }

    function renderDisplay(){
      const total = Math.max(0, Math.floor(state.remainingMs/1000));
      const mins = Math.floor(total/60);
      const secs = total % 60;
      displayMin.value = String(mins).padStart(2,'0');
      displaySec.value = String(secs).padStart(2,'0');
    }

    function updateStatus(){
      phaseTag.textContent = state.phase === 'focus'
        ? (isRunning() ? 'Focus running' : 'Focus paused')
        : (isRunning() ? 'Break running' : 'Break paused');
      status.textContent = state.runState.replace('_',' ').toLowerCase().replace(/\b\w/g,c=>c.toUpperCase());
      startPauseBtn.textContent = isRunning() ? 'Pause' : (state.runState === State.IDLE ? 'Start' : 'Resume');
      soundBtn.textContent = `Sound: ${state.soundOn ? 'On' : 'Off'}`;
      soundBtn.setAttribute('aria-pressed', state.soundOn);
      renderDisplay();
      setTabTitle();
    }

    function isRunning(){
      return state.runState === State.RUN_FOCUS || state.runState === State.RUN_BREAK;
    }

    /* ---------- Timer mechanics ---------- */
    let tickRaf = null;
    let tickTimeout = null;

    function clearTickHandles(){
      if(tickRaf){ cancelAnimationFrame(tickRaf); tickRaf = null; }
      if(tickTimeout){ clearTimeout(tickTimeout); tickTimeout = null; }
    }

    function scheduleTick(){
      clearTickHandles();
      if(!isRunning()) return;
      if(document.hidden){
        tickTimeout = setTimeout(tick, 500); // keep updating title in background
      }else{
        tickRaf = requestAnimationFrame(tick);
      }
    }

    function startTimer(){
      if(state.remainingMs <= 0){
        state.remainingMs = state.phase === 'focus' ? state.focusMs : state.breakMs;
      }
      if(state.phase === 'focus'){
        state.runState = State.RUN_FOCUS;
      }else{
        state.runState = State.RUN_BREAK;
      }
      const now = Date.now();
      state.endTs = now + state.remainingMs;
      ensureAudioUnlocked();
      scheduleTick();
      saveSettings();
      updateStatus();
    }

    function pauseTimer(){
      if(!isRunning()){
        return;
      }
      const remaining = state.endTs ? Math.max(0, state.endTs - Date.now()) : state.remainingMs;
      state.remainingMs = remaining;
      state.runState = state.phase === 'focus' ? State.PAUSE_FOCUS : State.PAUSE_BREAK;
      state.endTs = null;
      clearTickHandles();
      updateStatus();
    }

    function resetTimer(){
      state.remainingMs = state.phase === 'focus' ? state.focusMs : state.breakMs;
      state.runState = isRunning() ? (state.phase === 'focus' ? State.PAUSE_FOCUS : State.PAUSE_BREAK) : State.IDLE;
      clearTickHandles();
      state.endTs = null;
      updateStatus();
    }

    function tick(){
      if(!isRunning() || state.endTs === null){
        clearTickHandles();
        return;
      }
      const now = Date.now();
      const remaining = state.endTs - now;
      if(remaining <= 0){
        handleComplete();
        return;
      }
      state.remainingMs = remaining;
      updateStatus();
      scheduleTick();
    }

    function handleComplete(){
      playChime();
      if(state.phase === 'focus'){
        switchPhase('break');
      }else{
        switchPhase('focus');
      }
      if(state.auto){
        startTimer();
      }else{
        state.runState = state.phase === 'focus' ? State.PAUSE_FOCUS : State.PAUSE_BREAK;
        state.endTs = null;
        clearTickHandles();
        updateStatus();
      }
    }

    function switchPhase(next){
      state.phase = next;
      state.remainingMs = next === 'focus' ? state.focusMs : state.breakMs;
      state.runState = next === 'focus' ? State.PAUSE_FOCUS : State.PAUSE_BREAK;
      state.endTs = null;
      if(next === 'break' && state.activeBreak){
        rollExercise();
        activeCard.style.display = 'block';
      }else{
        activeCard.style.display = 'none';
      }
      setTabTitle();
    }

    /* ---------- Inputs ---------- */
    function renderDialFromState(){
      const mins = clamp(Math.round(state.focusMs/60_000) || 1, 1, 120);
      dialMinutes.textContent = mins;
      dial.style.setProperty('--dial-deg', `${mins/60*360}deg`);
      dial.style.setProperty('--dot-rot', `${mins/60*360-90}deg`);
    }

    function setFocusMinutes(mins){
      const clamped = clamp(mins, 1, 120);
      state.focusMs = clamped * 60_000 + getFocusSeconds();
      if(state.phase === 'focus' && !isRunning()){
        state.remainingMs = state.focusMs;
      }
      focusMinutesInput.value = clamped;
      renderDialFromState();
      saveSettings();
      updateStatus();
    }

    function setFocusSeconds(){
      const secs = clamp(Number(focusSecondsInput.value||0),0,59);
      focusSecondsInput.value = secs;
      state.focusMs = clamp(Number(focusMinutesInput.value||30),1,120) * 60_000 + secs*1000;
      if(state.phase === 'focus' && !isRunning()){
        state.remainingMs = state.focusMs;
      }
      renderDialFromState();
      saveSettings();
      updateStatus();
    }

    function setBreakMinutes(val){
      const mins = clamp(val,0,60);
      breakMinutesInput.value = mins;
      state.breakMs = mins*60_000;
      if(state.phase === 'break' && !isRunning()){
        state.remainingMs = state.breakMs;
      }
      saveSettings();
      updateStatus();
    }

    /* Manual edit from main display */
    function applyDisplayEdit(){
      const minLimit = 0; // allow zero minutes
      const mins = clamp(Number(displayMin.value || 0), minLimit, 60);
      const secs = clamp(Number(displaySec.value || 0), 0, 59);
      const totalMs = (mins*60 + secs) * 1000;
      state.remainingMs = totalMs;
      if(state.phase === 'focus'){
        state.focusMs = totalMs;
        focusMinutesInput.value = mins;
        focusSecondsInput.value = secs;
        renderDialFromState();
      }else{
        state.breakMs = totalMs;
        breakMinutesInput.value = mins;
      }
      if(isRunning()){
        state.endTs = Date.now() + state.remainingMs;
      }
      saveSettings();
      updateStatus();
    }

    function switchMode(mode){
      state.mode = mode;
      if(mode === 'dial'){
        dialPanel.style.display = '';
        digitalPanel.style.display = 'none';
        dialMode.classList.add('active');
        digitalMode.classList.remove('active');
      }else{
        dialPanel.style.display = 'none';
        digitalPanel.style.display = '';
        dialMode.classList.remove('active');
        digitalMode.classList.add('active');
      }
      saveSettings();
    }

    /* ---------- Dial interactions ---------- */
    function angleToMinutes(clientX, clientY){
      const rect = dial.getBoundingClientRect();
      const x = clientX - (rect.left + rect.width/2);
      const y = clientY - (rect.top + rect.height/2);
      const angle = Math.atan2(y, x) * 180/Math.PI; // -180..180
      const deg = (angle + 450) % 360; // 0 at top
      return clamp(Math.round(deg / 6), 1, 120); // 6 deg per minute, allow up to 120
    }

    function handleDialPointer(ev){
      ev.preventDefault();
      const mins = angleToMinutes(ev.clientX, ev.clientY);
      setFocusMinutes(mins);
    }

    function bindDial(){
      let dragging = false;
      dial.addEventListener('pointerdown', e => {
        dragging = true;
        dial.setPointerCapture(e.pointerId);
        handleDialPointer(e);
      });
      dial.addEventListener('pointermove', e => {
        if(!dragging) return;
        handleDialPointer(e);
      });
      dial.addEventListener('pointerup', e => {
        dragging = false;
        dial.releasePointerCapture(e.pointerId);
      });
      dial.addEventListener('pointerleave', () => dragging = false);
    }

    /* ---------- Exercises ---------- */
    function rollExercise(){
      const pick = EXERCISES[Math.floor(Math.random()*EXERCISES.length)];
      state.currentExercise = pick;
      exerciseText.textContent = pick;
    }

    /* ---------- Sound ---------- */
    let audioCtx = null;
    function getCtx(){
      if(!audioCtx){
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = AC ? new AC() : null;
      }
      return audioCtx;
    }
    function ensureAudioUnlocked(){
      const ctx = getCtx();
      if(ctx && ctx.state === 'suspended'){
        ctx.resume().catch(()=>{});
      }
      // also try the <audio> element once to satisfy some browsers
      try{ chime.volume = 0; chime.play().then(()=>chime.pause()); }catch(_){}
    }
    function synthBeep(){
      const ctx = getCtx();
      if(!ctx) return false;
      const now = ctx.currentTime;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(880, now);
      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(parseFloat(volume.value), now + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.45);
      osc.connect(gain).connect(ctx.destination);
      osc.start(now);
      osc.stop(now + 0.5);
      return true;
    }
    function playChime(){
      if(!state.soundOn) return;
      // try Web Audio first for reliability
      if(!synthBeep()){
        try{
          chime.currentTime = 0;
          chime.volume = parseFloat(volume.value);
          chime.play();
        }catch(_){
          status.textContent = 'Time’s up!';
        }
      }
    }

    /* ---------- Tab visibility accuracy ---------- */
    document.addEventListener('visibilitychange', () => {
      if(!isRunning()) return;
      const remaining = state.endTs - Date.now();
      if(remaining <= 0){
        handleComplete();
      }else{
        state.remainingMs = remaining;
        updateStatus();
        scheduleTick();
      }
    });

    /* ---------- Event wiring ---------- */
    startPauseBtn.addEventListener('click', () => {
      if(isRunning()){
        pauseTimer();
      }else{
        startTimer();
      }
    });

    resetBtn.addEventListener('click', resetTimer);
    skipBtn.addEventListener('click', () => {
      const wasRunning = isRunning();
      clearTickHandles();
      if(state.phase === 'focus'){
        switchPhase('break');
      }else{
        switchPhase('focus');
      }
      if(state.auto && wasRunning){
        startTimer();
      }else{
        state.runState = state.phase === 'focus' ? State.PAUSE_FOCUS : State.PAUSE_BREAK;
        clearTickHandles();
        updateStatus();
      }
    });

    soundBtn.addEventListener('click', () => {
      state.soundOn = !state.soundOn;
      saveSettings();
      updateStatus();
    });
    volume.addEventListener('input', () => {
      volLabel.textContent = Math.round(volume.value*100) + '%';
      saveSettings();
    });
    const previewVolume = () => { ensureAudioUnlocked(); playChime(); };
    volume.addEventListener('change', previewVolume);
    volume.addEventListener('pointerup', previewVolume);

    $('.preset[data-focus="15"]').onclick = () => setFocusMinutes(15);
    $('.preset[data-focus="30"]').onclick = () => setFocusMinutes(30);
    $('.preset[data-focus="60"]').onclick = () => setFocusMinutes(60);
    $('.preset[data-focus="90"]').onclick = () => setFocusMinutes(90);

    $('.break-preset[data-break="5"]').onclick = () => setBreakMinutes(5);
    $('.break-preset[data-break="10"]').onclick = () => setBreakMinutes(10);
    $('.break-preset[data-break="15"]').onclick = () => setBreakMinutes(15);

    focusMinutesInput.addEventListener('input', () => {
      const mins = clamp(Number(focusMinutesInput.value||30),1,120);
      focusMinutesInput.value = mins;
      setFocusMinutes(mins);
    });
    focusSecondsInput.addEventListener('input', setFocusSeconds);
    breakMinutesInput.addEventListener('input', () => setBreakMinutes(Number(breakMinutesInput.value||5)));

    dialMode.addEventListener('click', () => switchMode('dial'));
    digitalMode.addEventListener('click', () => switchMode('digital'));

    autoToggle.addEventListener('change', () => {
      state.auto = autoToggle.checked;
      saveSettings();
    });
    activeToggle.addEventListener('change', () => {
      state.activeBreak = activeToggle.checked;
      if(!state.activeBreak) activeCard.style.display = 'none';
      saveSettings();
    });

    newExercise.addEventListener('click', rollExercise);
    $('#doneExercise').addEventListener('click', () => {
      exerciseText.textContent = "Nice work. Breathe.";
    });

    const commitDisplay = () => applyDisplayEdit();
    ['change','blur'].forEach(evt => {
      displayMin.addEventListener(evt, commitDisplay);
      displaySec.addEventListener(evt, commitDisplay);
    });
    [displayMin, displaySec].forEach(inp => {
      inp.addEventListener('keydown', (e) => {
        if(e.key === 'Enter'){
          e.preventDefault();
          commitDisplay();
          inp.blur();
        }
      });
    });

    function getFocusSeconds(){
      return clamp(Number(focusSecondsInput.value||0),0,59)*1000;
    }

    /* ---------- Init ---------- */
    loadSettings();
    bindDial();
    setFocusMinutes(state.focusMs/60_000);
    setBreakMinutes(state.breakMs/60_000);
    switchMode(state.mode);
    autoToggle.checked = state.auto;
    activeToggle.checked = state.activeBreak;
    updateStatus();
    renderDisplay();
  </script>
</body>
</html>
